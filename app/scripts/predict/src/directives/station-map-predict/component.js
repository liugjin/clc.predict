// Generated by IcedCoffeeScript 108.0.13

/*
* File: station-map-predict-directive
* User: sheen
* Date: 2020/03/02
* Desc:
 */
if (typeof define !== 'function') { var define = require('amdefine')(module) };
var __bind = function(fn, me){ return function(){ return fn.apply(me, arguments); }; },
  __hasProp = {}.hasOwnProperty,
  __extends = function(child, parent) { for (var key in parent) { if (__hasProp.call(parent, key)) child[key] = parent[key]; } function ctor() { this.constructor = child; } ctor.prototype = parent.prototype; child.prototype = new ctor(); child.__super__ = parent.prototype; return child; };

define(['../base-directive', 'text!./style.css', 'text!./view.html', 'underscore', "moment", 'echarts'], function(base, css, view, _, moment, echarts) {
  var StationMapPredictDirective, exports;
  StationMapPredictDirective = (function(_super) {
    __extends(StationMapPredictDirective, _super);

    function StationMapPredictDirective($timeout, $window, $compile, $routeParams, commonService) {
      this.initMapData = __bind(this.initMapData, this);
      this.convertData2 = __bind(this.convertData2, this);
      this.convertData = __bind(this.convertData, this);
      this.addZero = __bind(this.addZero, this);
      this.getDevices = __bind(this.getDevices, this);
      this.setStationData = __bind(this.setStationData, this);
      this.loadStations = __bind(this.loadStations, this);
      this.show = __bind(this.show, this);
      this.id = "station-map";
      StationMapPredictDirective.__super__.constructor.call(this, $timeout, $window, $compile, $routeParams, commonService);
    }

    StationMapPredictDirective.prototype.setScope = function() {};

    StationMapPredictDirective.prototype.setCSS = function() {
      return css;
    };

    StationMapPredictDirective.prototype.setTemplate = function() {
      return view;
    };

    StationMapPredictDirective.prototype.show = function(scope, element, attrs) {
      var e, _ref;
      scope.data = [];
      scope.geoCoordMap = {};
      scope.geoCoord = [];
      scope.times = "";
      e = element.find('.echartsContent');
      if ((_ref = scope.myChart) != null) {
        _ref.dispose();
      }
      scope.myChart = null;
      scope.myChart = echarts.init(e[0]);
      scope.levelColorMap = {
        '1': 'rgba(241, 109, 115, .8)',
        '2': 'rgba(255, 235, 59, .7)',
        '3': 'rgba(147, 235, 248, 1)'
      };
      this.loadStations(scope);
      scope.jumpPage = (function(_this) {
        return function(station) {
          if (station.station === 'china') {
            return;
          }
          return window.location.hash = "#/station-info/" + scope.project.model.user + "/" + scope.project.model.project + "/" + station.station;
        };
      })(this);
      scope.day = moment().format('YYYY-MM-DD');
      scope.time = moment().format('HH:mm:ss');
      scope.date = moment().format('dddd');
      clearInterval(scope.interval);
      return scope.interval = setInterval((function(_this) {
        return function() {
          scope.day = moment().format('YYYY-MM-DD');
          scope.time = moment().format('HH:mm:ss');
          scope.date = moment().format('dddd');
          scope.$applyAsync();
          scope.times = "" + scope.day + " " + scope.time + " " + scope.date;
          return _this.initMapData(scope);
        };
      })(this), 60000);
    };

    StationMapPredictDirective.prototype.loadStations = function(scope) {
      return scope.project.loadStations(null, (function(_this) {
        return function(err, stations) {
          scope.stations = stations;
          if (scope.stations.length > 0) {
            return _this.setStationData(scope);
          }
        };
      })(this));
    };

    StationMapPredictDirective.prototype.setStationData = function(scope) {
      var sta, _i, _len, _ref, _results;
      _ref = scope.stations;
      _results = [];
      for (_i = 0, _len = _ref.length; _i < _len; _i++) {
        sta = _ref[_i];
        this.getDevices(scope, sta, (function(_this) {
          return function(d) {
            return _this.initMapData(scope);
          };
        })(this));
        scope.geoCoordMap[sta.model.name] = [sta.model.longitude, sta.model.latitude];
        if (!sta.model.parent) {
          _results.push(scope.geoCoord = [sta.model.longitude, sta.model.latitude]);
        } else {
          _results.push(void 0);
        }
      }
      return _results;
    };

    StationMapPredictDirective.prototype.getDevices = function(scope, site, callback) {
      var dataValue, index, newEquips, sta, _i, _len, _ref, _results;
      if (site.model.parent !== '') {
        return site.loadEquipments(null, null, (function(_this) {
          return function(err, equipments) {
            var dataValue, item, newEquips, _i, _len;
            newEquips = [];
            for (_i = 0, _len = equipments.length; _i < _len; _i++) {
              item = equipments[_i];
              if (item.model.type !== "_station_management") {
                newEquips.push(item);
              }
            }
            dataValue = {
              station: '',
              name: '',
              value: 0
            };
            dataValue.station = site.model.station;
            dataValue.name = site.model.name;
            dataValue.value = _this.addZero(newEquips.length);
            scope.data.push(dataValue);
            return typeof callback === "function" ? callback(scope.data) : void 0;
          };
        })(this));
      } else {
        newEquips = [];
        index = 0;
        dataValue = {
          station: '',
          name: '',
          value: 0
        };
        dataValue.station = site.model.station;
        dataValue.name = site.model.name;
        _ref = site.stations;
        _results = [];
        for (_i = 0, _len = _ref.length; _i < _len; _i++) {
          sta = _ref[_i];
          index++;
          _results.push(sta.loadEquipments(null, null, (function(_this) {
            return function(err, equipments) {
              var item, _j, _len1;
              for (_j = 0, _len1 = equipments.length; _j < _len1; _j++) {
                item = equipments[_j];
                if (item.model.type !== '_station_management') {
                  newEquips.push(item);
                }
              }
              if (index = site.stations.length) {
                dataValue.value = newEquips.length;
                scope.data.push(dataValue);
                return typeof callback === "function" ? callback(scope.data) : void 0;
              }
            };
          })(this)));
        }
        return _results;
      }
    };

    StationMapPredictDirective.prototype.addZero = function(num) {
      if (parseInt(num) < 10 && parseInt(num) > 0) {
        num = '0' + num;
      }
      return num;
    };

    StationMapPredictDirective.prototype.convertData = function(scope, data) {
      var geoCoord, i, res, _i, _len;
      res = [];
      for (_i = 0, _len = data.length; _i < _len; _i++) {
        i = data[_i];
        geoCoord = scope.geoCoordMap[i.name];
        if (geoCoord) {
          res.push({
            station: i.station,
            name: i.name,
            value: geoCoord.concat(i.value)
          });
        }
      }
      return res;
    };

    StationMapPredictDirective.prototype.convertData2 = function(scope, data) {
      var geoCoord, i, res, toCoord, _i, _len;
      res = [];
      for (_i = 0, _len = data.length; _i < _len; _i++) {
        i = data[_i];
        geoCoord = scope.geoCoordMap[i.name];
        if (i.station === 'china') {
          toCoord = scope.geoCoordMap[i.name];
        }
        if (geoCoord && i.name !== '华新水泥') {
          res.push([
            {
              coord: geoCoord,
              value: i.value
            }, {
              coord: toCoord
            }
          ]);
        }
      }
      return res;
    };

    StationMapPredictDirective.prototype.initMapData = function(scope) {
      var series, zhongguo;
      zhongguo = "/lib/echarts/map/json/china.json";
      series = [];
      echarts.extendsMap = (function(_this) {
        return function(id, opt) {
          var option;
          [['华新水泥', scope.data]].forEach(function(item, i) {
            return series.push({
              type: 'lines',
              zlevel: 2,
              effect: {
                show: true,
                period: 4,
                trailLength: 0.02,
                symbol: 'arrow',
                symbolSize: 5
              },
              lineStyle: {
                normal: {
                  color: '#0faa57',
                  width: 1,
                  opacity: 1,
                  curveness: .3
                }
              },
              data: _this.convertData2(scope, item[1])
            }, {
              type: 'effectScatter',
              coordinateSystem: 'geo',
              zlevel: 2,
              rippleEffect: {
                brushType: 'stroke'
              },
              symbol: 'circle',
              symbolSize: 10,
              hoverAnimation: false,
              label: {
                normal: {
                  color: '#fff',
                  formatter: function(params) {
                    if (typeof params.value[2] === "undefined") {
                      return ' ' + params.name + '(' + params.value + ')';
                    } else {
                      return ' ' + params.name + '(' + params.value[2] + ')';
                    }
                  },
                  position: 'right',
                  show: true
                },
                emphasis: {
                  show: true
                }
              },
              itemStyle: {
                normal: {
                  color: scope.levelColorMap[3]
                }
              },
              data: _.filter(item[1].map(function(dataItem) {
                return {
                  station: dataItem.station,
                  name: dataItem.name,
                  value: scope.geoCoordMap[dataItem.name].concat([dataItem.value])
                };
              }), function(d) {
                return d.station !== 'china';
              })
            }, {
              type: 'scatter',
              coordinateSystem: 'geo',
              zlevel: 2,
              symbol: 'image://data:image/png;base64,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',
              symbolSize: 16,
              hoverAnimation: false,
              label: {
                normal: {
                  color: '#fff',
                  formatter: function(params) {
                    if (typeof params.value[2] === "undefined") {
                      return ' ' + params.name + '(' + params.value + ')';
                    } else {
                      return ' ' + params.name + '(' + params.value[2] + ')';
                    }
                  },
                  position: 'right',
                  show: true
                },
                emphasis: {
                  show: true
                }
              },
              itemStyle: {
                normal: {
                  color: function(params) {
                    return scope.levelColorMap[3];
                  }
                }
              },
              data: [
                {
                  station: 'china',
                  name: item[0],
                  value: scope.geoCoordMap[item[0]].concat([
                    (_.find(item[1], function(d) {
                      return d.station === 'china';
                    })).value
                  ])
                }
              ]
            });
          });
          option = {
            title: {
              text: '华新水泥全国厂区站点概览图',
              subtext: scope.times,
              x: 'center',
              y: "4%",
              textStyle: {
                color: '#F3F6FE',
                fontSize: 28
              },
              subtextStyle: {
                color: '#F3F6FE',
                fontSize: 18
              }
            },
            tooltip: {
              trigger: 'item',
              formatter: function(params) {},
              formatter: function(params, ticket, callback) {
                var _ref;
                if (((_ref = params.seriesType) === "scatter" || _ref === "effectScatter")) {
                  return params.name + ' : ' + params.value[2];
                } else if (params.seriesType === "lines") {
                  return params.data.value;
                } else {
                  return params.name;
                }
              }
            },
            geo: {
              map: opt.mapName,
              show: true,
              roam: true,
              label: {
                normal: {
                  show: false
                },
                emphasis: {
                  show: false
                }
              },
              itemStyle: {
                normal: {
                  areaColor: '#02204E',
                  borderColor: '#004E8D'
                },
                emphasis: {
                  areaColor: '#004E8D'
                }
              }
            },
            series: series
          };
          scope.myChart.setOption(option);
          return scope.myChart.on('click', function(params) {
            if (params.componentType === "series") {
              return scope.jumpPage(params.data);
            }
          });
        };
      })(this);
      return $.getJSON(zhongguo, (function(_this) {
        return function(geoJson) {
          var myChart;
          echarts.registerMap('china', geoJson);
          return myChart = echarts.extendsMap('map', {
            bgColor: 'transparent',
            mapName: 'china',
            text: '',
            goDown: false,
            callback: function(name, option, instance) {}
          });
        };
      })(this));
    };

    StationMapPredictDirective.prototype.resize = function(scope) {
      var _ref;
      return (_ref = scope.myChart) != null ? _ref.resize() : void 0;
    };

    StationMapPredictDirective.prototype.dispose = function(scope) {
      var _ref;
      if ((_ref = scope.myChart) != null) {
        _ref.dispose();
      }
      return clearInterval(scope.interval);
    };

    return StationMapPredictDirective;

  })(base.BaseDirective);
  return exports = {
    StationMapPredictDirective: StationMapPredictDirective
  };
});
