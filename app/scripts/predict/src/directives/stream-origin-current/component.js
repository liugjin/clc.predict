// Generated by IcedCoffeeScript 108.0.13

/*
* File: stream-origin-current-directive
* User: David
* Date: 2020/03/19
* Desc:
 */
if (typeof define !== 'function') { var define = require('amdefine')(module) };
var __bind = function(fn, me){ return function(){ return fn.apply(me, arguments); }; },
  __hasProp = {}.hasOwnProperty,
  __extends = function(child, parent) { for (var key in parent) { if (__hasProp.call(parent, key)) child[key] = parent[key]; } function ctor() { this.constructor = child; } ctor.prototype = parent.prototype; child.prototype = new ctor(); child.__super__ = parent.prototype; return child; };

define(['../base-directive', 'text!./style.css', 'text!./view.html', 'underscore', "moment", "echarts"], function(base, css, view, _, moment, echarts) {
  var StreamOriginCurrentDirective, exports;
  StreamOriginCurrentDirective = (function(_super) {
    __extends(StreamOriginCurrentDirective, _super);

    function StreamOriginCurrentDirective($timeout, $window, $compile, $routeParams, commonService) {
      this.show = __bind(this.show, this);
      this.id = "stream-origin-current";
      StreamOriginCurrentDirective.__super__.constructor.call(this, $timeout, $window, $compile, $routeParams, commonService);
    }

    StreamOriginCurrentDirective.prototype.setScope = function() {};

    StreamOriginCurrentDirective.prototype.setCSS = function() {
      return css;
    };

    StreamOriginCurrentDirective.prototype.setTemplate = function() {
      return view;
    };

    StreamOriginCurrentDirective.prototype.show = function(scope, element, attrs) {
      var chartelement, commands, createOption, currentSignal, fields, getStreamSignalData, _ref;
      scope.playFlag = false;
      scope.interval1 = null;
      currentSignal = scope.parameters.currentSignal;
      scope.chartOpts = {};
      scope.chartDatas = {};
      scope.equipSubscription = {};
      scope.chartOpts.legends = [];
      scope.chartOpts.yDatas = [];
      chartelement = element.find('#ss-origin-chart');
      scope.mychart = echarts.init(chartelement[0]);
      scope.dataFlag = false;
      scope.chartOpts.end = 2;
      scope.chartOpts.start = 0;
      scope.currentMinAndMax = [0, 0];
      scope.chartOpts.title = scope.parameters.currentName + '采集数据图';
      fields = null;
      commands = [];
      scope.streamCommands = {};
      scope.equipment.loadCommands(fields, (function(_this) {
        return function(err, model) {
          var command, item, sindex, _i, _len, _results;
          if (model) {
            _results = [];
            for (_i = 0, _len = model.length; _i < _len; _i++) {
              command = model[_i];
              if (command.model.group === 'stream') {
                sindex = scope.parameters.currentSignal.split('-')[2];
                item = command.model.command.split('-');
                if (item[2] === sindex) {
                  scope.streamCommands.schedule = command;
                  _this.initializeCommand(scope.streamCommands.schedule, scope.equipment);
                  _results.push(_this.command = scope.streamCommands.schedule);
                } else if (item[1] === sindex) {
                  scope.streamCommands.queue = command;
                  _results.push(_this.initializeCommand(scope.streamCommands.queue, scope.equipment));
                } else {
                  _results.push(void 0);
                }
              } else {
                _results.push(void 0);
              }
            }
            return _results;
          }
        };
      })(this), true);
      scope.originalStream = (function(_this) {
        return function() {
          _this.commonService.publishEventBus('old-new-stream-flag', 'new');
          return scope.$applyAsync();
        };
      })(this);
      scope.executionCommandClose = (function(_this) {
        return function() {
          return $('#command-execution-modal').modal('close');
        };
      })(this);
      scope.updateOriginData = (function(_this) {
        return function() {
          scope.streamCommands.schedule.model.parameters[0].value = 1;
          _this.commonService.executeCommand(scope.streamCommands.schedule);
          return $('#command-execution-modal').modal('open');
        };
      })(this);
      scope.stopQueryExecuting = function() {
        scope.queryToExecuting = false;
        return scope.commandError = null;
      };
      scope.queryToExecuteCommand = (function(_this) {
        return function(command) {
          return scope.queryToExecuting = true;
        };
      })(this);
      scope.queryToCancelCommand = function(command) {
        return scope.queryToExecuting = true;
      };
      scope.doExecuteCommand = (function(_this) {
        return function(command) {
          if (!scope.queryToExecuting) {
            return;
          }
          scope.stopQueryExecuting();
          _this.display("数据采集中...");
          return setTimeout(function() {
            _this.executeCommand2(command);
            return setTimeout(function() {
              var _ref;
              if ((_ref = scope.commandSubscription) != null) {
                _ref.dispose();
              }
              return scope.commandSubscription = _this.commonService.subscribeCommandValue(command, function(cmd) {});
            }, 100);
          }, 10000);
        };
      })(this);
      scope.doCancelCommand = (function(_this) {
        return function(command) {
          if (!scope.queryToExecuting) {
            return;
          }
          scope.stopQueryExecuting();
          return _this.cancelCommand2(command);
        };
      })(this);
      scope.downLoadStream = (function(_this) {
        return function() {
          if (scope.urls.length === 1) {
            return window.open(scope.urls[0], '_blank');
          } else if (scope.urls.length === 3) {
            window.open(scope.urls[0], '_blank');
            return setTimeout(function() {
              window.open(scope.urls[1], '_blank');
              return setTimeout(function() {
                return window.open(scope.urls[2], '_blank');
              }, 3000);
            }, 4000);
          } else {
            return _this.display("暂无数据，无法下载！");
          }
        };
      })(this);
      getStreamSignalData = (function(_this) {
        return function() {
          var filter, strId, _ref;
          if (currentSignal === 's-data-7') {
            scope.legendList = ['A相电流', 'B相电流', 'C相电流'];
          } else if (currentSignal === 's-data-5' || currentSignal === 's-data-6') {
            scope.legendList = ['X轴震动', 'Y轴震动', 'Z轴震动'];
          } else {
            scope.legendList = [scope.parameters.currentName];
          }
          scope.chartOpts.legends = scope.legendList;
          filter = {
            user: scope.project.model.user,
            project: scope.project.model.project,
            station: scope.equipment.model.station,
            equipment: scope.equipment.model.equipment,
            signal: currentSignal
          };
          strId = scope.equipment.key + "-" + currentSignal;
          if ((_ref = scope.equipSubscription[strId]) != null) {
            _ref.dispose();
          }
          return scope.equipSubscription[strId] = _this.commonService.signalLiveSession.subscribeValues(filter, function(err, signal) {
            var item, str, _i, _len;
            scope.chartDatas.xData = [];
            scope.urls = [];
            if (signal.message && signal.message.value) {
              scope.dataFlag = true;
              scope.collectTime = moment(signal.message.timestamp).format("YYYY-MM-DD HH:mm:ss");
              scope.chartOpts.subtext = scope.collectTime;
              scope.$root.loading = true;
              str = signal.message.value.split(',');
              for (_i = 0, _len = str.length; _i < _len; _i++) {
                item = str[_i];
                scope.urls.push(item);
              }
              if (scope.urls.length === 1) {
                scope.chartDatas.yData = [[]];
                return $.get(scope.urls[0], null, function(data) {
                  var i, index, j, strs, _j, _len1;
                  strs = data.split("\n");
                  strs.pop();
                  for (j = _j = 0, _len1 = strs.length; _j < _len1; j = ++_j) {
                    i = strs[j];
                    index = j + 1;
                    scope.chartDatas.xData.push(index);
                    scope.chartDatas.yData[0].push(Number(i));
                  }
                  scope.chartOpts.yData = scope.chartDatas.yData;
                  scope.chartOpts.xData = scope.chartDatas.xData;
                  scope.calcMinAndMax(scope.chartDatas.yData);
                  return createOption(scope.chartOpts);
                });
              } else if (scope.urls.length === 3) {
                scope.chartDatas.yData = [[], [], []];
                return $.get(scope.urls[0], null, function(data1) {
                  var i, index, j, strs, _j, _len1;
                  strs = data1.split("\n");
                  strs.pop();
                  for (j = _j = 0, _len1 = strs.length; _j < _len1; j = ++_j) {
                    i = strs[j];
                    index = j + 1;
                    scope.chartDatas.xData.push(index);
                    scope.chartDatas.yData[0].push(Number(i));
                  }
                  return $.get(scope.urls[1], null, function(data2) {
                    var _k, _len2;
                    strs = data2.split("\n");
                    strs.pop();
                    for (_k = 0, _len2 = strs.length; _k < _len2; _k++) {
                      j = strs[_k];
                      scope.chartDatas.yData[1].push(Number(j));
                    }
                    return $.get(scope.urls[2], null, function(data3) {
                      var k, _l, _len3;
                      strs = data3.split("\n");
                      strs.pop();
                      for (_l = 0, _len3 = strs.length; _l < _len3; _l++) {
                        k = strs[_l];
                        scope.chartDatas.yData[2].push(Number(k));
                      }
                      scope.chartOpts.yData = scope.chartDatas.yData;
                      scope.chartOpts.xData = scope.chartDatas.xData;
                      scope.calcMinAndMax(scope.chartDatas.yData);
                      return createOption(scope.chartOpts);
                    });
                  });
                });
              }
            }
          });
        };
      })(this);
      if (scope.parameters.streamFlag) {
        getStreamSignalData();
      } else {
        if ((_ref = scope.mychart) != null) {
          _ref.dispose();
        }
        scope.mychart = null;
      }
      scope.chartShowAll = (function(_this) {
        return function() {
          clearInterval(scope.interval1);
          scope.playFlag = false;
          if (scope.mychart && scope.chartOpts && scope.chartDatas.xData) {
            scope.chartOpts.yData = scope.chartDatas.yData;
            return scope.reSetChartOpts(scope.chartOpts);
          }
        };
      })(this);
      scope.chartPlayPause = (function(_this) {
        return function() {
          if (!scope.playFlag) {
            if (scope.mychart && scope.chartOpts && scope.chartDatas.xData) {
              if (scope.chartOpts.yData[0].length === scope.chartDatas.xData.length) {
                if (scope.chartOpts.legends.length === 3) {
                  scope.chartOpts.yData = [[], [], []];
                } else {
                  scope.chartOpts.yData = [[]];
                }
              }
              scope.playFlag = true;
              return scope.interval1 = setInterval(function() {
                var i;
                if (scope.chartOpts.yData[0].length < scope.chartDatas.xData.length) {
                  i = 0;
                  while (i < 4) {
                    if (scope.chartOpts.legends.length === 3) {
                      scope.chartOpts.yData[0].push(scope.chartDatas.yData[0][scope.chartOpts.yData[0].length]);
                      scope.chartOpts.yData[1].push(scope.chartDatas.yData[1][scope.chartOpts.yData[1].length]);
                      scope.chartOpts.yData[2].push(scope.chartDatas.yData[2][scope.chartOpts.yData[2].length]);
                    } else {
                      scope.chartOpts.yData[0].push(scope.chartDatas.yData[0][scope.chartOpts.yData[0].length]);
                    }
                    i++;
                  }
                } else {
                  scope.chartOpts.yData = [[]];
                }
                return scope.reSetChartOpts(scope.chartOpts);
              }, 1000);
            }
          } else {
            clearInterval(scope.interval1);
            return scope.playFlag = false;
          }
        };
      })(this);
      scope.reSetChartOpts = (function(_this) {
        return function(opts) {
          var index, item, series1, _i, _len, _ref1;
          series1 = [];
          _ref1 = opts.yData;
          for (index = _i = 0, _len = _ref1.length; _i < _len; index = ++_i) {
            item = _ref1[index];
            series1.push({
              data: item
            });
          }
          return scope.mychart.setOption({
            series: series1
          });
        };
      })(this);
      scope.checkIfNumber = (function(_this) {
        return function(val) {
          if (!isNaN(Number(val))) {
            return Number(val);
          } else {
            return 0;
          }
        };
      })(this);
      scope.calcMinAndMax = (function(_this) {
        return function(data) {
          var i, index, item, j, k, newData, yDataMinAndMax, _i, _j, _k, _len, _len1, _len2;
          yDataMinAndMax = [];
          newData = [];
          for (j = _i = 0, _len = data.length; _i < _len; j = ++_i) {
            i = data[j];
            newData.push([]);
            for (_j = 0, _len1 = i.length; _j < _len1; _j++) {
              k = i[_j];
              newData[j].push(scope.checkIfNumber(k));
            }
          }
          if (data.length === 3) {
            for (index = _k = 0, _len2 = newData.length; _k < _len2; index = ++_k) {
              item = newData[index];
              yDataMinAndMax.push(Math.min.apply(Math, item), Math.max.apply(Math, item));
            }
            scope.currentMinAndMax = [Math.min.apply(Math, yDataMinAndMax), Math.max.apply(Math, yDataMinAndMax)];
          } else {
            yDataMinAndMax.push(Math.min.apply(Math, newData[0]), Math.max.apply(Math, newData[0]));
            scope.currentMinAndMax = yDataMinAndMax;
          }
          return scope.$applyAsync();
        };
      })(this);
      return createOption = (function(_this) {
        return function(opts) {
          var colors, index, item, option, series, _i, _legendData, _len, _ref1;
          colors = [['#1A45A2', '#00E7EE'], ['#90D78A', '#1CAA9E'], ['#F9722C', '#FF085C']];
          series = [];
          _ref1 = opts.yData;
          for (index = _i = 0, _len = _ref1.length; _i < _len; index = ++_i) {
            item = _ref1[index];
            series.push({
              name: opts.legends[index],
              type: 'line',
              symbol: "none",
              smooth: true,
              data: item,
              lineStyle: {
                width: 2,
                color: {
                  type: 'linear',
                  x: 0,
                  y: 0,
                  x2: 0,
                  y2: 1,
                  colorStops: [
                    {
                      offset: 0,
                      color: colors[index][0]
                    }, {
                      offset: 1,
                      color: colors[index][1]
                    }
                  ]
                }
              }
            });
          }
          _legendData = _.map(opts.legends, function(d, i) {
            return {
              name: d,
              icon: "image://" + _this.getComponentPath('image/color' + (i + 1) + '.svg')
            };
          });
          option = {
            title: {
              text: opts.title,
              textStyle: {
                color: '#fff'
              },
              left: 'center',
              top: 0,
              subtext: '采集时间' + opts.subtext,
              subtextStyle: {
                color: 'rgba(156,165,193,1)',
                fontSize: 14
              }
            },
            tooltip: {
              show: true,
              trigger: "axis",
              axisPointer: {
                type: 'cross'
              }
            },
            legend: {
              show: true,
              right: '2%',
              orient: "horizontal",
              textStyle: {
                fontSize: 14,
                color: "#FFFFFF"
              },
              data: _legendData
            },
            grid: {
              right: 20
            },
            toolbox: {
              show: true,
              right: 20,
              feature: {
                dataZoom: {
                  show: false
                },
                dataView: {
                  show: false
                },
                magicType: {
                  show: false
                },
                restore: {
                  show: false
                },
                saveAsImage: {
                  show: false
                }
              }
            },
            dataZoom: [
              {
                type: 'inside',
                realtime: true,
                start: opts.start,
                end: opts.end
              }, {
                show: true,
                realtime: true,
                type: 'slider',
                height: 20,
                borderColor: 'rgba(2,62,116,1)',
                dataBackground: {
                  lineStyle: {
                    width: 3,
                    color: {
                      type: 'linear',
                      x: 0,
                      y: 0,
                      x2: 0,
                      y2: 1,
                      colorStops: [
                        {
                          offset: 0,
                          color: '#1A45A2'
                        }, {
                          offset: 1,
                          color: '#00E7EE'
                        }
                      ]
                    }
                  },
                  areaStyle: {
                    color: {
                      type: 'linear',
                      x: 0,
                      y: 0,
                      x2: 0,
                      y2: 1,
                      colorStops: [
                        {
                          offset: 0,
                          color: '#1A45A2'
                        }, {
                          offset: 1,
                          color: '#00E7EE'
                        }
                      ]
                    }
                  }
                },
                handleStyle: {
                  color: 'rgba(0,167,255,1)'
                },
                textStyle: {
                  fontSize: 14,
                  color: "#FFFFFF"
                },
                fillerColor: "rgba(2,62,116,0.8)",
                bottom: 0
              }
            ],
            xAxis: {
              show: false,
              nameTextStyle: {
                color: '#fff'
              },
              data: opts.xData,
              type: 'category',
              boundaryGap: false,
              nameLocation: "middle",
              axisLine: {
                onZero: false,
                lineStyle: {
                  color: "#204BAD"
                }
              },
              axisLabel: {
                show: false,
                textStyle: {
                  color: "#fff"
                }
              }
            },
            yAxis: {
              type: 'value',
              axisLine: {
                lineStyle: {
                  color: "#204BAD"
                }
              },
              axisLabel: {
                textStyle: {
                  color: "rgba(156,165,193,1)"
                }
              },
              splitLine: {
                lineStyle: {
                  color: ["#204BAD"]
                }
              }
            },
            series: series
          };
          scope.$root.loading = false;
          return scope.mychart.setOption(option);
        };
      })(this);
    };

    StreamOriginCurrentDirective.prototype.initializeCommand = function(command, equipment) {
      var instance;
      instance = {};
      if (instance.name == null) {
        instance.name = command.model.name;
      }
      if (instance.enable == null) {
        instance.enable = command.model.enable;
      }
      return command.instance = instance;
    };

    StreamOriginCurrentDirective.prototype.executeCommand2 = function(command, comment) {
      var data, model, parameters;
      model = command.model;
      parameters = command.getParameterValues();
      data = command.getIds();
      data.priority = model.priority;
      data.phase = 'executing';
      data.parameters = parameters;
      data.startTime = new Date;
      data.endTime = null;
      data.result = null;
      data.trigger = 'user';
      data.operator = this.$window.$controller.$rootScope.user.user;
      data.operatorName = this.$window.$controller.$rootScope.user.name;
      data.comment = comment != null ? comment : model.comment;
      return this.commonService.commandLiveSession.executeCommand(data);
    };

    StreamOriginCurrentDirective.prototype.cancelCommand2 = function(command, comment) {
      var data, k, v, _ref;
      if (!command._data) {
        return;
      }
      data = {};
      _ref = command._data;
      for (k in _ref) {
        v = _ref[k];
        data[k] = v;
      }
      data.phase = 'cancel';
      data.trigger = 'user';
      data.endTime = new Date;
      data.operator = this.$window.$controller.$rootScope.user.user;
      data.operatorName = this.$window.$controller.$rootScope.user.name;
      data.comment = comment != null ? comment : command.model.comment;
      return this.commonService.commandLiveSession.executeCommand(data);
    };

    StreamOriginCurrentDirective.prototype.resize = function(scope) {
      return this.$timeout((function(_this) {
        return function() {
          var _ref;
          return (_ref = scope.mychart) != null ? _ref.resize() : void 0;
        };
      })(this), 0);
    };

    StreamOriginCurrentDirective.prototype.dispose = function(scope) {
      var key, value, _ref, _ref1, _ref2;
      _ref = scope.equipSubscription;
      for (key in _ref) {
        value = _ref[key];
        if (value != null) {
          value.dispose();
        }
      }
      if ((_ref1 = scope.mychart) != null) {
        _ref1.dispose();
      }
      scope.mychart = null;
      scope.chartOpts = null;
      scope.chartDatas = null;
      clearInterval(scope.interval1);
      return (_ref2 = scope.commandSubscription) != null ? _ref2.dispose() : void 0;
    };

    return StreamOriginCurrentDirective;

  })(base.BaseDirective);
  return exports = {
    StreamOriginCurrentDirective: StreamOriginCurrentDirective
  };
});
